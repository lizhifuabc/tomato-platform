# 支付系统的路由系统设计

支付系统的路由系统设计是确保支付交易能够高效、稳定地选择合适的支付渠道进行处理的关键。路由系统需要综合考虑多个因素，包括支付方式、支付通道的可用性、交易费用、交易速度、安全性等。下面是支付系统路由系统设计的一些建议：

1. 支付渠道选择：
   1. 商家配置的支付方式选择最合适的支付渠道。
   2. 需要对支付渠道的性能、可靠性、覆盖范围进行评估，从而为每个交易选择最佳的支付渠道。
2. 路由策略：路由系统需要定义合适的路由策略，根据交易的特性和商家的需求来决定选择哪个支付渠道。例如，对于国际支付，可以优先选择支持跨境支付的渠道，对于高金额交易，可以选择更安全可靠的渠道等。
3. 交易速度和安全性：在支付交易中，速度和安全性是两个重要的考虑因素。路由系统应该能够根据交易的紧急程度和金额大小，选择快速处理且安全性高的支付渠道。
4. 费用优化：路由系统应该考虑支付渠道的交易费用，以最小化支付成本。这需要综合考虑交易费用、交易成功率和其他因素，选择最经济实惠的支付渠道。
5. 备用路由：为了确保支付系统的稳定性，路由系统应该设置备用路由，当主要支付渠道不可用时，能够自动切换到备用渠道进行处理。
6. 实时监测：支付路由系统应该实时监测支付渠道的状态和性能，及时发现异常情况并采取相应措施，保障支付系统的稳定运行。
7. 数据分析与优化：路由系统应该提供数据分析功能，对支付渠道的性能、交易成功率、费用等进行监控和分析，从而优化路由策略，提高支付系统的效率和性能。
8. 合规性与安全：支付路由系统必须遵守支付行业的合规标准和相关法规，确保交易数据的安全性和隐私保护。
9. 可扩展性：随着业务的增长，支付系统的交易量可能会增加。路由系统应该具备良好的可扩展性，能够支持大规模的并发交易处理。
10. 优先级管理：支付路由系统应该根据不同交易的优先级进行管理，确保重要的交易能够优先得到处理。

综合考虑以上因素，支付系统的路由系统能够高效地选择合适的支付渠道进行处理，从而提供稳定、安全、快速的支付服务。

## 渠道筛选

1. 人工路由：适合渠道很少的情况。
2. 规则路由：一般可以通过收集到的条件，进行数据库查询的时候，自行匹配出合适的渠道，并完成优劣选择，这是最常用的方式；
3. 权重的路由：这种方式比较复杂，且权重的设置需要不断的尝试，也可能针对不同的场景还要有多套权重设置方案，实操起来并不简单。

常见是1+2的组合进行。

## 通道监控

监控流程：

1. 收款和付款时通过通道路由，筛选出可用的通道列表。
2. 根据筛选的通道调用网关下单或打款，由网关来向三方发起请求。
3. 请求结束后将三方返回的结果通过 MQ 上报到通道监控系统。
4. 监控系统在监听到消息后，将监控的数据存储到 Redis。
5. 数据计算模块拉取 Redis 的数据进行筛选过滤，汇总计算各通道的失败率等各个信息。
6. 根据通道配置的告警规则进行通道异常通知。

数据存储：

1. Redis 中的数据会定期向 MySQL 备份，以便后续故障分析使用。
2. 通过离线任务定时清理 Redis 中的数据，避免 Redis 中存储的数据量过大

数据可视化：

1. 将收集到的数据指标上报到了 Prometheus，通过 Grafana 数据看板来观察通道健康度。

监控执行：

1. 前期进行手动上下线通道，防止算法出现问题。
2. 通过进行通道监控数据的分析，进行基于监控的通道自动化管理。

## Redis 数据存储结构

```shell
1.set
存储统计的渠道
key: channel:alarm
value: wx:101(支付方式+渠道编号)
       wx:102
       wx:103
       .......

2.zset
存储指定渠道请求的时间戳（秒），同一秒的数据会覆盖存储
key: channel:alarm:time:wx-101(支付方式+渠道编号)
      score: 1657164225（时间戳） value: 1657164225（时间戳）
      score: 1657164226 value: 1657164226
      score: 1657164227 value: 1657164227
      .......

3.hash
存储指定渠道1秒内的请求结果, 每秒汇总一份结果
key: channel:alarm:result:wx-101(支付方式+渠道编号):1657164227（时间戳）
      key: success             value: 10 (次数)
      key: fail                value: 5
      key: balance_not_enough  value: 3
      key: thrid_error         value: 2
      .......   
```

