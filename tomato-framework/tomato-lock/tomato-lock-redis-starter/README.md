# redis 分布式锁

基于 Redis 实现分布式锁。

## 原子性

1. 加锁：核心目的。
2. 过期时间：防止别的线程永远获取不到锁。

为了保证上面的两个步骤的完整性，通常采用 set 命名：

set key value ex 10 nx

```js
set指令扩展参数：SET key value[EX seconds][PX milliseconds][NX|XX]

- NX :表示key不存在的时候，才能set成功，也即保证只有第一个客户端请求才能获得锁，
  而其他客户端请求只能等其释放锁，才能获取。
- EX seconds :设定key的过期时间，时间单位是秒。
- PX milliseconds: 设定key的过期时间，单位为毫秒
- XX: 仅当key存在时设置值
```

## 释放锁

1. 超时释放锁
2. 手动释放锁：`Redis+Lua`脚本来完成，保证原子性，

为了防止线程持有的锁被其他线程释放，通常加锁时会添加线程请求的唯一标记，然后在释放锁的时候进行判断。

## 锁超时释放，业务还在执行

Redisson `watch dog`看门狗添加后台线程，会每隔`10`秒检查一下，如果线程一还持有锁，那么就会不断的延长锁`key`的生存时间。

## @Transactional

事务没有提交之前,分布式锁已经被释放，导致分布式锁失效。





